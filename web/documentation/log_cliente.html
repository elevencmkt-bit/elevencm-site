<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Log de Jobs por Cliente – Eleven CM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Log de jobs para compartilhamento com o cliente." />
  <link rel="icon" type="image/png" href="../img/ico.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #fbfcfe;
      --text: #1f2a3d;
      --muted: #5f6b7a;
      --brand: #febe01;
      --brand-strong: #d9a700;
      --border: #e4e8f0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: "Raleway", system-ui, -apple-system, sans-serif;
      padding: 20px 14px 40px;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1180px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .logo-box {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .logo-box img {
      height: 62px;
      width: auto;
      object-fit: contain;
    }

    .share-actions {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    button {
      border-radius: 8px;
      border: 1px solid rgba(254, 190, 1, 0.4);
      background: linear-gradient(135deg, rgba(254, 190, 1, 0.16), rgba(254, 190, 1, 0.06));
      color: #1f2a3d;
      font-weight: 700;
      padding: 10px 14px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, border-color 0.15s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(26, 54, 93, 0.12);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 22px 24px;
      box-shadow: 0 15px 50px rgba(26, 54, 93, 0.08);
    }

    .heading {
      margin: 0 0 6px;
      letter-spacing: -0.01em;
    }

    .muted {
      margin: 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    .filters label {
      font-weight: 700;
      color: var(--text);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filters input,
    .filters select {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f7f9fc;
      font: inherit;
      min-width: 240px;
    }

    .log-status {
      margin-top: 6px;
      font-weight: 700;
    }

    .log-status.success {
      color: #15803d;
    }

    .log-status.error {
      color: #b91c1c;
    }

    .log-status.muted {
      color: var(--muted);
      font-weight: 600;
    }

    .logs-container {
      margin-top: 12px;
      display: grid;
      gap: 12px;
    }

    details.log-item {
      border: 1px solid #e4e8f0;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 12px 40px rgba(26, 54, 93, 0.06);
      overflow: hidden;
    }

    details.log-item[open] {
      border-color: rgba(254, 190, 1, 0.4);
      box-shadow: 0 16px 45px rgba(26, 54, 93, 0.1);
    }

    details.log-item summary {
      list-style: none;
      cursor: pointer;
      padding: 12px 14px;
      display: block;
      background: #f9fbff;
      border-bottom: 1px solid #eef1f6;
      user-select: none;
    }

    details.log-item summary::-webkit-details-marker {
      display: none;
    }

    .summary-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      min-width: 0;
    }

    .summary-title {
      font-weight: 800;
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }

    .summary-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .summary-meta .pill {
      white-space: nowrap;
    }

    .log-body {
      padding: 14px 16px 16px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid #e4e8f0;
      background: #f7f9fc;
      color: var(--text);
      font-weight: 700;
      font-size: 0.85rem;
    }

    .pill.brand {
      border-color: rgba(254, 190, 1, 0.5);
      background: rgba(254, 190, 1, 0.12);
    }

    .mono {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      letter-spacing: 0.02em;
    }

    .log-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px 16px;
    }

    .log-field span {
      display: block;
      font-weight: 800;
      font-size: 0.92rem;
      color: var(--text);
    }

    .log-field p {
      margin: 4px 0 0;
      color: var(--muted);
      white-space: pre-line;
      line-height: 1.5;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .empty-state {
      border: 1px dashed #d7deea;
      border-radius: 10px;
      padding: 14px;
      background: #f8fafc;
      color: var(--muted);
      font-weight: 600;
    }

    @media (max-width: 780px) {
      body {
        padding: 16px 12px 32px;
      }

      header {
        align-items: flex-start;
      }

      .filters {
        flex-direction: column;
        align-items: flex-start;
      }

      .filters input,
      .filters select {
        min-width: 100%;
        width: 100%;
      }

      .summary-content {
        flex-wrap: wrap;
      }

      /* No menu/summary em mobile, mantém só a data de criação */
      .summary-meta .pill:not(:first-child) {
        display: none;
      }
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
      }

      header,
      .filters,
      .share-actions {
        display: none !important;
      }

      .card {
        box-shadow: none;
        border: 1px solid #dcdfe6;
      }

      details.log-item {
        box-shadow: none;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="logo-box">
        <img src="../img/logo_eleven_black.png" alt="Eleven CM" />
      </div>
      <div class="share-actions">
        <button id="copyLinkBtn">Copiar link</button>
        <button id="pdfBtn">Salvar em PDF</button>
      </div>
    </header>

    <div class="card">
      <h1 class="heading" id="clientHeading">Log de jobs</h1>
      <p class="muted" id="clientSub">Visualização dos jobs do cliente.</p>

      <div class="filters">
        <label>
          Cliente
          <input type="text" id="clienteIdInput" readonly />
        </label>
        <label>
          Mês (opcional)
          <input type="month" id="monthInput" />
        </label>
        <button id="reloadBtn">Atualizar</button>
      </div>

      <div id="logStatus" class="log-status muted" role="status" aria-live="polite">Carregando…</div>
      <div id="logsContainer" class="logs-container" aria-live="polite"></div>
    </div>
  </div>

  <script>
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbzix5fHMp_bu9qRILNypw_Zl3d6wwYQ2N_ihUVG3sm-JfHXOeN0cA1_dMHMTaxkOGHQ1g/exec";

    const labels = {
      objective: "Objetivo",
      context: "Contexto",
      audience: "Público",
      references: "Referências",
      social: "Social / Peças",
      campaign: "Campanha / Mídia",
      ads: "Ads",
      video: "Vídeo",
      site: "Site",
      branding: "Branding / Identidade",
      notes: "Observações e links",
      deadline: "Prazo",
      created: "Cadastro",
      untitled: "(Sem título)",
      withoutType: "Tipo não informado",
      empty: "Nenhum job encontrado para este cliente.",
      error: "Não foi possível carregar os jobs agora.",
      copied: "Link copiado para a área de transferência.",
    };

    const clienteIdInput = document.getElementById("clienteIdInput");
    const monthInput = document.getElementById("monthInput");
    const reloadBtn = document.getElementById("reloadBtn");
    const logsContainer = document.getElementById("logsContainer");
    const logStatus = document.getElementById("logStatus");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const pdfBtn = document.getElementById("pdfBtn");
    const clientHeading = document.getElementById("clientHeading");
    const clientSub = document.getElementById("clientSub");

    function setStatus(msg, variant = "muted") {
      if (!logStatus) return;
      logStatus.textContent = msg || "";
      logStatus.className = `log-status ${variant}`;
    }

    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || "";
    }

    function formatDate(raw) {
      if (!raw) return "";
      const parsed = new Date(raw);
      if (Number.isNaN(parsed.getTime())) return String(raw);
      return parsed.toLocaleDateString("pt-BR", {
        day: "2-digit",
        month: "short",
        year: "numeric",
      });
    }

    function formatDateTime(raw) {
      if (!raw) return "";
      const parsed = new Date(raw);
      if (Number.isNaN(parsed.getTime())) return String(raw);
      return parsed.toLocaleString("pt-BR", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    const normalize = (value) => (value ? String(value).trim() : "");
    const formatList = (value) =>
      normalize(value)
        .split(/[,;\n]+/)
        .map((item) => item.trim())
        .filter(Boolean)
        .join(" · ");

    function isSameMonth(job, monthValue) {
      if (!monthValue) return true;
      const normalized = monthValue.trim();
      if (!normalized) return true;
      if (job.mes_ano && String(job.mes_ano).startsWith(normalized)) return true;
      const parsed = job.data_cadastro ? new Date(job.data_cadastro) : null;
      if (parsed && !Number.isNaN(parsed.getTime())) {
        const year = parsed.getFullYear();
        const month = String(parsed.getMonth() + 1).padStart(2, "0");
        return `${year}-${month}` === normalized;
      }
      return false;
    }

    async function loadLogs() {
      const clienteId = getParam("cliente") || getParam("cliente_id");
      if (!clienteId) {
        setStatus("Informe o cliente na URL (?cliente=CLI-123).", "error");
        return;
      }
      clienteIdInput.value = clienteId;
      setStatus("Carregando...", "muted");
      logsContainer.innerHTML = "";

      const url = `${ENDPOINT_URL}?action=jobs&cliente_id=${encodeURIComponent(clienteId)}&limit=400`;
      try {
        const resp = await fetch(url, { method: "GET" });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        let jobs = Array.isArray(data?.jobs) ? data.jobs : [];
        const monthFilter = monthInput?.value || getParam("mes") || "";
        if (monthFilter) {
          if (monthInput) monthInput.value = monthFilter;
          jobs = jobs.filter((job) => isSameMonth(job, monthFilter));
        }

        if (!jobs.length) {
          logsContainer.innerHTML = `<div class="empty-state">${labels.empty}</div>`;
          setStatus(labels.empty, "muted");
          return;
        }

        renderLogs(jobs);
        clientHeading.textContent = `Log de jobs — ${jobs[0]?.cliente_nome || clienteId}`;
        clientSub.textContent = `Visualização dos jobs do cliente ${jobs[0]?.cliente_nome || clienteId}.`;
        setStatus(`${jobs.length} jobs listados`, "success");
      } catch (err) {
        console.error("Erro ao carregar log de jobs", err);
        setStatus(labels.error, "error");
      }
    }

    function renderLogs(jobs) {
      const markup = jobs.map((job) => buildJobMarkup(job)).join("");
      logsContainer.innerHTML = markup;
    }

    function buildJobMarkup(job) {
      const metaLine = [job.job_tipo, job.tipo_demanda_social, job.canal_midias].filter(Boolean).join(" · ");
      const created = formatDateTime(job.data_cadastro);
      const deadline = formatDate(job.prazo_entrega_desejado);

      const summaryMeta = [
        created && `<span class="pill">${created}</span>`,
        deadline && `<span class="pill">${labels.deadline}: ${deadline}</span>`,
        job.prioridade && `<span class="pill brand">${job.prioridade}</span>`,
        job.job_id && `<span class="pill mono">${job.job_id}</span>`,
      ]
        .filter(Boolean)
        .join("");

      const fields = [
        renderField(labels.objective, job.objetivo_principal),
        renderField(labels.context, job.contexto_job),
        renderField(labels.audience, job.publico_job),
        renderField(labels.references, job.links_referencias),
        renderField(labels.social, formatSocial(job)),
        renderField(labels.campaign, formatCampaign(job)),
        renderField(labels.ads, formatAds(job)),
        renderField(labels.video, formatVideo(job)),
        renderField(labels.site, formatSite(job)),
        renderField(labels.branding, formatBrand(job)),
      ]
        .filter(Boolean)
        .join("");

      return `
        <details class="log-item">
          <summary>
            <div class="summary-content">
              <div class="summary-title">${job.job_titulo || labels.untitled}</div>
              <div class="summary-meta">${summaryMeta}</div>
            </div>
          </summary>
          <div class="log-body">
            ${job.mes_ano ? `<div class="pill" style="margin-bottom:8px;">${job.mes_ano}</div>` : ""}
            ${metaLine ? `<p class="muted" style="margin: 0 0 12px; font-weight:700;">${metaLine}</p>` : ""}
            <div class="log-fields">
              ${fields}
            </div>
          </div>
        </details>
      `;
    }

    function renderField(label, value) {
      if (!value) return "";
      return `<div class="log-field"><span>${label}</span><p>${value}</p></div>`;
    }

    function formatSocial(job) {
      const parts = [
        formatList(job.sm_formato),
        job.sm_qtd_pecas && `${job.sm_qtd_pecas} peças`,
        job.sm_legenda_completa,
        job.sm_tom_voz,
        job.sm_cta,
      ].filter(Boolean);
      return parts.join(" · ");
    }

    function formatCampaign(job) {
      const parts = [
        job.sm_camp_objetivo_principal,
        job.sm_camp_periodo_inicio && job.sm_camp_periodo_fim
          ? `${formatDate(job.sm_camp_periodo_inicio)} -> ${formatDate(job.sm_camp_periodo_fim)}`
          : "",
        formatList(job.sm_camp_plataformas),
        formatList(job.sm_camp_meta_resultado),
        formatList(job.sm_camp_entregaveis),
        job.sm_camp_pagina_destino,
        job.sm_camp_segmentacoes,
        job.sm_camp_localizacao,
        job.sm_camp_orcamento_total && `Budget: ${job.sm_camp_orcamento_total}`,
        job.sm_camp_orcamento_diario && `Daily: ${job.sm_camp_orcamento_diario}`,
        job.sm_camp_observacoes_gerais,
      ].filter(Boolean);
      return parts.join(" · ");
    }

    function formatAds(job) {
      const parts = [
        job.ads_objetivo,
        formatList(job.ads_plataformas),
        job.ads_orcamento,
        job.ads_periodo,
        job.ads_oferta_principal,
        job.ads_publico_segmentacao,
      ].filter(Boolean);
      return parts.join(" · ");
    }

    function formatVideo(job) {
      const parts = [
        job.video_tipo,
        job.video_duracao,
        job.video_formato,
        job.video_tipo_trabalho,
        job.video_materiais_disponiveis,
        job.video_local,
      ].filter(Boolean);
      return parts.join(" · ");
    }

    function formatSite(job) {
      const parts = [
        job.site_tipo,
        job.site_objetivo,
        job.site_paginas,
        job.site_funcionalidades,
        job.site_dominio,
        job.site_responsavel_conteudo,
      ].filter(Boolean);
      return parts.join(" · ");
    }

    function formatBrand(job) {
      const parts = [
        job.brand_situacao_atual,
        formatList(job.brand_entregaveis),
        job.brand_palavras_chave,
      ].filter(Boolean);
      return parts.join(" · ");
    }

    function updateUrlMonth() {
      const monthVal = monthInput?.value;
      const url = new URL(window.location.href);
      if (monthVal) url.searchParams.set("mes", monthVal);
      else url.searchParams.delete("mes");
      window.history.replaceState({}, "", url.toString());
    }

    reloadBtn?.addEventListener("click", () => {
      updateUrlMonth();
      loadLogs();
    });

    monthInput?.addEventListener("change", updateUrlMonth);

    copyLinkBtn?.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        setStatus(labels.copied, "success");
      } catch (err) {
        console.error("Erro ao copiar link", err);
        setStatus("Não foi possível copiar o link.", "error");
      }
    });

    pdfBtn?.addEventListener("click", () => window.print());

    loadLogs();
  </script>
</body>

</html>
