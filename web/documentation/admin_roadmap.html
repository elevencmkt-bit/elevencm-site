<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · Roadmap de Conteúdo – Eleven CM</title>
  <meta name="description" content="Painel interno para cadastrar e editar roadmaps mensais por cliente." />
  <link rel="icon" type="image/png" href="../img/ico.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: radial-gradient(circle at 15% 20%, #fff7e6 0, #fff 38%), radial-gradient(circle at 80% 0%, #f0f4ff 0, #fff 45%), #f7f9fc;
      --panel: #ffffff;
      --border: #e7ebf3;
      --muted: #5a6475;
      --text: #141b2f;
      --brand: #febe01;
      --brand-strong: #d89d00;
      --shadow: 0 18px 60px rgba(20, 27, 47, 0.08);
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: "Space Grotesk", "Raleway", system-ui, -apple-system, sans-serif;
      padding: 24px 18px 48px;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1320px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    header.topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 18px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand img {
      height: 56px;
      width: auto;
    }

    .brand h1 {
      margin: 0;
      letter-spacing: -0.02em;
      font-size: 1.4rem;
    }

    .brand small {
      display: block;
      color: var(--muted);
      font-weight: 500;
      margin-top: 4px;
    }

    .top-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border-radius: 12px;
      border: 1px solid rgba(254, 190, 1, 0.55);
      background: linear-gradient(135deg, rgba(254, 190, 1, 0.16), rgba(254, 190, 1, 0.06));
      color: var(--text);
      font-weight: 700;
      padding: 10px 14px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, border-color 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 35px rgba(20, 27, 47, 0.12);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button.secondary {
      background: #f1f5f9;
      border-color: #d8e0ee;
      color: #1f2a3d;
    }

    button.danger {
      background: #fff1f2;
      border-color: #fecdd3;
      color: #9f1239;
    }

    .panel {
      padding: 18px;
      display: grid;
      gap: 14px;
    }

    h2 {
      margin: 0 0 4px;
      letter-spacing: -0.01em;
    }

    .muted {
      color: var(--muted);
      margin: 0;
      line-height: 1.6;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .flex {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    label.field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 700;
      color: var(--text);
      flex: 1;
      min-width: 180px;
    }

    .field input,
    .field select,
    .field textarea {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f8fafc;
      padding: 10px 12px;
      font: inherit;
      color: inherit;
      width: 100%;
    }

    .field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
    }

    .table thead {
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
    }

    .table th,
    .table td {
      padding: 10px 10px;
      text-align: left;
      vertical-align: top;
      font-size: 0.95rem;
    }

    .table th {
      font-weight: 800;
      color: #0f172a;
      white-space: nowrap;
    }

    .table tbody tr:nth-child(every) {
      background: #fff;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f7f9fc;
      font-weight: 700;
    }

    .status {
      border-radius: 8px;
      padding: 8px 10px;
      font-weight: 700;
      color: #0f172a;
      border: 1px solid #e4e8f0;
      background: #f7f9fc;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .status[data-status="sent_to_client"] {
      background: #eef2ff;
      border-color: #c7d2fe;
      color: #312e81;
    }

    .status[data-status="approved"] {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #166534;
    }

    .status[data-status="changes_requested"] {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #c2410c;
    }

    .status[data-status="draft"] {
      background: #f8fafc;
      border-color: #e2e8f0;
      color: #475569;
    }

    .comment-btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #e4e8f0;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      color: #0f172a;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .comment-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(20, 27, 47, 0.1);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 16px;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      max-width: 520px;
      width: 100%;
      padding: 18px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.28);
      border: 1px solid #e5e7eb;
    }

    .modal h3 {
      margin: 0 0 10px;
    }

    .modal .modal-body {
      white-space: pre-line;
      line-height: 1.6;
      color: #0f172a;
    }

    .modal .modal-actions {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
    }

    .modal .close-btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f8fafc;
      cursor: pointer;
      font-weight: 700;
    }

    .modal .close-btn:hover {
      background: #eef2ff;
    }

    .modal .preview-box {
      display: grid;
      place-items: center;
      max-height: 80vh;
    }

    .modal .preview-box img,
    .modal .preview-box video {
      max-width: 100%;
      max-height: 75vh;
      object-fit: contain;
    }

    .inline-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f8fafc;
      font: inherit;
    }

    .actions-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .chip {
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      padding: 7px 12px;
      color: #f8fafc;
      font-weight: 600;
    }

    .welcome {
      padding: 18px 18px 14px;
      background: linear-gradient(120deg, #111827, #1e293b);
      color: #f7fafc;
      border-radius: var(--radius);
      border: 1px solid #0f172a;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.28);
    }

    @media (max-width: 1020px) {
      .table {
        display: block;
        overflow-x: auto;
      }

      .table th,
      .table td {
        min-width: 160px;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <header class="topbar">
      <div class="brand">
        <img src="../img/logo_eleven_black.png" alt="Eleven CM" />
        <div>
          <h1>Admin · Roadmap</h1>
          <small>Uso interno · editar posts do mês</small>
        </div>
      </div>
      <div class="top-actions">
        <button id="loadBtn" class="secondary">Carregar</button>
        <button id="generateLinkBtn">Gerar link</button>
      </div>
    </header>

    <section class="panel card">
      <div class="flex" style="align-items:flex-end;">
        <label class="field" style="max-width: 320px;">
          Cliente
          <select id="clientSelect"></select>
        </label>
        <label class="field" style="max-width: 180px;">
          Mês (YYYY-MM)
          <input id="monthInput" type="month" />
        </label>
        <div class="actions-row" style="align-items:flex-end;">
          <button id="resetDbBtn" class="danger" style="white-space:nowrap;">Resetar demo</button>
        </div>
      </div>
    </section>

    <section class="panel card">
      <div class="footer">
        <h2 style="margin:0;">Posts do mês</h2>
        <div class="actions-row">
          <button id="addPostBtn" class="secondary">+ Adicionar post</button>
        </div>
      </div>
      <div class="card" style="background:#f8fafc;border:1px dashed #d8deea;margin:12px 0;">
        <p style="margin:0 0 8px;font-weight:700;">Upload rápido (arraste ou selecione vários arquivos)</p>
        <p style="margin:0 0 12px;color:#5a6475;">Cada arquivo cria uma linha com a legenda preenchida pelo nome. Depois ajuste data e link do Drive (salvo em 30 dias você pode apagar as artes no Drive).</p>
        <div id="dropzone" style="padding:18px;border:1px dashed #c7d2e3;border-radius:12px;background:#fff;cursor:pointer;text-align:center;">
          Solte as artes/vídeos aqui ou clique para selecionar
          <input id="fileInput" type="file" multiple accept="image/*,video/*" style="display:none;">
        </div>
        <div id="uploadStatus" style="display:none;margin-top:10px;font-weight:700;color:#0f172a;"></div>
      </div>
      <div class="table-wrapper">
        <table class="table" id="postsTable" aria-label="Tabela de posts">
          <thead>
            <tr>
              <th>Thumb</th>
              <th>#</th>
              <th>Data</th>
              <th>Canal</th>
              <th>Legenda</th>
              <th>Status</th>
              <th>Comentário</th>
              <th>Ordem</th>
              <th>Remover</th>
            </tr>
          </thead>
          <tbody id="postsTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzix5fHMp_bu9qRILNypw_Zl3d6wwYQ2N_ihUVG3sm-JfHXOeN0cA1_dMHMTaxkOGHQ1g/exec"; // endpoint único
    const ASSET_ACTION = "roadmap_upload_asset";
    const clientSelect = document.getElementById("clientSelect");
    const monthInput = document.getElementById("monthInput");
    const postsTbody = document.getElementById("postsTbody");

    const statusOptions = [
      { value: "draft", label: "draft" },
      { value: "sent_to_client", label: "sent_to_client" },
      { value: "approved", label: "approved" },
      { value: "changes_requested", label: "changes_requested" },
    ];

    const channelOptions = [
      "Instagram Feed",
      "Instagram Reels",
      "Stories",
      "Facebook",
      "LinkedIn",
      "TikTok",
      "YouTube",
    ];
  const dropzone = document.getElementById("dropzone");
  const fileInput = document.getElementById("fileInput");
  const uploadStatus = document.getElementById("uploadStatus");

    let postsToDelete = [];
    let loadedRoadmap = null;
    let loadedPosts = [];

    async function request(url, options = {}) {
      const init = { ...options };
      if (init.method === "POST") {
        // Usa text/plain para evitar preflight/CORS; corpo em JSON string.
        init.headers = { "Content-Type": "text/plain;charset=utf-8" };
        if (init.body && typeof init.body !== "string") {
          init.body = JSON.stringify(init.body);
        }
      }
      const resp = await fetch(url, init);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    async function loadClients() {
      const data = await request(`${API_URL}?action=clients`);
      const clients = Array.isArray(data?.clients) ? data.clients : [];
      if (!clients.length) throw new Error("Nenhum cliente encontrado na planilha.");
      clientSelect.innerHTML = clients.map((c) => `<option value="${c.slug}">${c.name}</option>`).join("");
      return clients;
    }

    async function apiGetRoadmap({ client_slug, month }) {
      const data = await request(`${API_URL}?action=roadmap&client_slug=${encodeURIComponent(client_slug)}&month=${encodeURIComponent(month)}`);
      if (!data?.roadmap) throw new Error("Roadmap não encontrado.");
      return data;
    }

    async function apiSaveRoadmap(payload) {
      const resp = await request(API_URL, {
        method: "POST",
        body: { action: "roadmap_save", ...payload },
      });
      return resp;
    }

  function toInputDate(value) {
    if (!value) return "";
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return value;
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function renderPosts(posts) {
      loadedPosts = posts;
      postsTbody.innerHTML = posts
        .sort((a, b) => (a.date || "").localeCompare(b.date || "") || (a.order || 0) - (b.order || 0))
        .map((post, idx) => {
          const media = post.__preview || post.drive_asset_url || "";
          const thumb = buildThumb(media, post.caption);
          const status = post.status || "sent_to_client";
          return `
            <tr data-id="${post.id || ""}" data-status="${post.status || ""}" data-drive="${post.drive_asset_url || ""}" data-preview="${post.__preview || ""}">
              <td>${thumb}</td>
              <td>${idx + 1}</td>
              <td><input class="inline-input" type="date" value="${toInputDate(post.date)}" data-key="date"></td>
              <td>
                <select class="inline-input" data-key="channel">
                  ${channelOptions.map((c) => `<option value="${c}" ${post.channel === c ? "selected" : ""}>${c}</option>`).join("")}
                </select>
              </td>
              <td><textarea class="inline-input" rows="3" data-key="caption" placeholder="Legenda">${post.caption || ""}</textarea></td>
              <td><span class="status" data-status="${status}">${status}</span></td>
              <td>
                ${post.client_comment ? `<button class="comment-btn" data-action="viewComment" data-id="${post.id}">Ver comentário</button>` : `<span style="color:#94a3b8;font-weight:700;">—</span>`}
              </td>
              <td><input class="inline-input" type="number" value="${post.order ?? idx + 1}" data-key="order" min="1"></td>
              <td><button class="secondary" data-action="remove">Remover</button></td>
            </tr>
          `;
        })
        .join("");
  }

  function drivePreview(url) {
    if (!url) return "";
    const str = String(url);
    if (str.startsWith("blob:")) return str; // prévia local
    const m1 = str.match(/\/file\/d\/([^/]+)/);
    const m2 = str.match(/[?&]id=([^&]+)/);
    let id = "";
    if (m1 && m1[1]) id = m1[1];
    else if (m2 && m2[1]) id = m2[1];
    if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w400`;
    return str;
  }

  function buildThumb(url, alt = "thumb") {
    if (!url) return "";
    const media = drivePreview(url);
    if (media.startsWith("blob:")) {
      return `<img src="${media}" alt="${alt || "thumb"}" data-action="viewImage" data-img="${media}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;cursor:pointer;">`;
    }
    const isVideo = /\.(mp4|mov|webm|mkv|avi|m4v)$/i.test(media);
    const isImage =
      /\.(png|jpe?g|webp|gif|heic)$/i.test(media) ||
      media.includes("google.com/thumbnail");
    if (isImage) {
      return `<img src="${media}" alt="${alt || "thumb"}" data-action="viewImage" data-img="${media}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;cursor:pointer;">`;
    }
    if (isVideo) {
      return `<video src="${media}" data-action="viewImage" data-img="${media}" style="width:48px;height:48px;border-radius:8px;object-fit:cover;cursor:pointer;" muted playsinline></video>`;
    }
    return `<a href="${media}" target="_blank" rel="noreferrer">link</a>`;
  }

  function getRowsData() {
    return Array.from(postsTbody.querySelectorAll("tr")).map((tr) => {
      const data = {
        id: tr.dataset.id || undefined,
        drive_asset_url: tr.dataset.drive || "",
        __preview: tr.dataset.preview || tr.dataset.drive || "",
        status: tr.dataset.status || "sent_to_client",
        client_comment: "",
      };
      tr.querySelectorAll("[data-key]").forEach((el) => {
        const key = el.dataset.key;
        if (el.type === "number") data[key] = Number(el.value) || 0;
        else data[key] = (el.value || "").trim();
      });
      // preserva status carregado; se novo post, default = sent_to_client
      const existing = loadedPosts.find((p) => p.id === data.id);
      data.status = existing?.status || data.status || "sent_to_client";
      data.client_comment = existing?.client_comment || "";
      return data;
    });
  }

    function fileNameToCaption(name) {
      if (!name) return "";
      return name.replace(/\.[^.]+$/, "").replace(/[_-]+/g, " ").trim();
    }

    function fileToPreview(file) {
      try {
        return URL.createObjectURL(file);
      } catch (_) {
        return "";
      }
    }

    async function uploadFileAndCreatePost(file) {
      const client_slug = clientSelect.value;
      const month = monthInput.value;
      if (!client_slug || !month) {
        throw new Error("Selecione cliente e mês antes de subir arquivos.");
      }
      const localPreview = fileToPreview(file);
      const readerBase64 = await fileToBase64(file);
      const resp = await request(API_URL, {
        method: "POST",
        body: {
          action: ASSET_ACTION,
          client_slug,
          month,
          filename: file.name,
          mimeType: file.type || "application/octet-stream",
          base64: readerBase64,
        },
      });
      if (!resp?.success || !resp.url) throw new Error("Falha ao enviar arquivo.");
      return {
        date: "",
        channel: channelOptions[0],
        caption: fileNameToCaption(file.name),
        drive_asset_url: resp.url,
        status: "sent_to_client",
        order: 0,
        __preview: localPreview || resp.url,
      };
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const res = reader.result;
          const base64 = res.split(",")[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function handleFiles(files) {
      const list = Array.from(files || []);
      if (!list.length) return;
      const current = getRowsData();
      showUploadStatus(true, `Enviando 0/${list.length}...`);
      const results = [];
      try {
        for (let i = 0; i < list.length; i++) {
          const file = list[i];
          const post = await uploadFileAndCreatePost(file);
          results.push(post);
          showUploadStatus(true, `Enviando ${i + 1}/${list.length}...`);
        }
        const merged = current.concat(results.map((p, idx) => ({ ...p, order: current.length + idx + 1 })));
        renderPosts(merged);
      } catch (err) {
        alert(err.message || "Falha ao enviar arquivos.");
      } finally {
        showUploadStatus(false);
      }
    }

    function addPostRow() {
      const current = getRowsData();
      current.push({
        date: "",
        channel: channelOptions[0],
        caption: "",
        drive_asset_url: "",
        status: "sent_to_client",
        order: current.length + 1,
      });
      renderPosts(current);
    }

    async function onLoad() {
      try {
        const client_slug = clientSelect.value;
        const month = monthInput.value;
        if (!client_slug || !month) {
          alert("Selecione cliente e mês.");
          return;
        }
        const existingRows = getRowsData();
        const { client, roadmap, posts } = await apiGetRoadmap({ client_slug, month });
        loadedRoadmap = roadmap;
        postsToDelete = [];
        const list = Array.isArray(posts)
          ? posts.map((p) => ({
              ...p,
              __preview: p.drive_asset_url || "",
            }))
          : [];
        if (list.length) {
          renderPosts(list);
        } else if (!existingRows.length) {
          renderPosts([{
            date: "",
            channel: channelOptions[0],
            caption: "",
            drive_asset_url: "",
            status: "sent_to_client",
            order: 1,
          }]);
        } // se já havia linhas preenchidas, mantém
      } catch (err) {
        alert(err.message || "Erro ao carregar.");
      }
    }

    async function onSave(silent = false) {
      try {
        const client_slug = clientSelect.value;
        const month = monthInput.value;
        if (!client_slug || !month) {
          alert("Selecione cliente e mês.");
          return null;
        }
        const posts = getRowsData();
        if (!posts.length) {
          alert("Adicione ao menos um post antes de gerar o link.");
          return null;
        }
        const validation = validatePosts(posts);
        if (!validation.ok) {
          alert(validation.message);
          return null;
        }
        const payload = {
          client_slug,
          month,
          title: `Roadmap Social – ${month}`,
          notes_client: "",
          notes_internal: "",
          posts,
          posts_to_delete: postsToDelete,
        };
        const result = await apiSaveRoadmap(payload);
        postsToDelete = [];
        renderPosts(Array.isArray(result.posts) ? result.posts : []);
        loadedRoadmap = result.roadmap;
        if (!silent) alert("Roadmap salvo.");
        return result;
      } catch (err) {
        alert(err.message || "Erro ao salvar.");
        return null;
      }
    }

    function openClientPage() {
      const client_slug = clientSelect.value;
      const month = monthInput.value;
      if (!client_slug || !month) {
        alert("Selecione cliente e mês.");
        return;
      }
      const url = `./roadmap_public.html?client_slug=${encodeURIComponent(client_slug)}&month=${encodeURIComponent(month)}`;
      window.open(url, "_blank");
    }

    document.getElementById("addPostBtn").addEventListener("click", addPostRow);
    document.getElementById("loadBtn").addEventListener("click", onLoad);
    document.getElementById("generateLinkBtn").addEventListener("click", async () => {
      const saved = await onSave(true);
      if (saved) openClientPage();
    });
    document.getElementById("resetDbBtn").addEventListener("click", () => {
      postsTbody.innerHTML = "";
      postsToDelete = [];
      alert("Nada para resetar localmente. Os dados vêm da planilha (end-point).");
    });

    function validatePosts(posts) {
      const errors = [];
      posts.forEach((p, idx) => {
        const n = idx + 1;
        if (!p.caption) errors.push(`Legenda obrigatória no post ${n}`);
        if (!p.drive_asset_url) errors.push(`Arte/link obrigatório no post ${n}`);
        if (!p.date) errors.push(`Data obrigatória no post ${n}`);
      });
      return { ok: errors.length === 0, message: errors.join("\n") };
    }

    postsTbody.addEventListener("click", (event) => {
      if (event.target.dataset.action === "remove") {
        const tr = event.target.closest("tr");
        const id = tr?.dataset.id;
        if (id) postsToDelete.push(id);
        tr?.remove();
      } else if (event.target.dataset.action === "viewComment") {
        const id = event.target.dataset.id;
        const post = loadedPosts.find((p) => p.id === id);
        const bodyEl = document.getElementById("modalBody");
        if (bodyEl) {
          bodyEl.textContent = post?.client_comment || "Sem comentário.";
          modalOverlay.style.display = "flex";
        }
      } else if (event.target.dataset.action === "viewImage") {
        const src = event.target.dataset.img || "";
        const bodyEl = document.getElementById("modalBody");
        if (bodyEl && src) {
          bodyEl.innerHTML = `<div class="preview-box">${
            /\.(mp4|mov|webm|mkv|avi|m4v)$/i.test(src)
              ? `<video src="${src}" controls></video>`
              : `<img src="${src}" alt="Prévia">`
          }</div>`;
          modalOverlay.style.display = "flex";
        }
      }
    });

    function initFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const c = params.get("client_slug");
      const m = params.get("month");
      if (c) clientSelect.value = c;
      if (m) monthInput.value = m;
    }

    async function init() {
      try {
        await loadClients();
        initFromQuery();
      } catch (err) {
        alert(err.message || "Erro ao carregar clientes. Verifique o script/planilha.");
      }
    }

    if (dropzone && fileInput) {
      dropzone.addEventListener("click", () => fileInput.click());
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.style.background = "#eef2ff";
      });
      dropzone.addEventListener("dragleave", () => {
        dropzone.style.background = "#fff";
      });
      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.style.background = "#fff";
        if (e.dataTransfer?.files?.length) {
          handleFiles(e.dataTransfer.files);
        }
      });
      fileInput.addEventListener("change", (e) => {
        if (e.target.files?.length) handleFiles(e.target.files);
      });
    }

    function showUploadStatus(show, text = "") {
    if (!uploadStatus) return;
    uploadStatus.style.display = show ? "block" : "none";
    uploadStatus.textContent = text;
  }

  const modalOverlay = document.createElement("div");
  modalOverlay.className = "modal-overlay";
  modalOverlay.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Comentário do cliente</h3>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions"><button class="close-btn" id="closeModalBtn">Fechar</button></div>
    </div>
  `;
  document.body.appendChild(modalOverlay);
  document.getElementById("closeModalBtn").addEventListener("click", () => {
    modalOverlay.style.display = "none";
  });
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) modalOverlay.style.display = "none";
  });

  init();
</script>
</body>

</html>
