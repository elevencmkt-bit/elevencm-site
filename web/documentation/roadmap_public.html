<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roadmap do Cliente – Eleven CM</title>
  <meta name="description" content="Visualização pública do roadmap de conteúdos do cliente." />
  <link rel="icon" type="image/png" href="../img/ico.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f9fc;
      --panel: #ffffff;
      --border: #e7ebf3;
      --muted: #5a6475;
      --text: #141b2f;
      --brand: #febe01;
      --brand-strong: #d89d00;
      --shadow: 0 16px 40px rgba(20, 27, 47, 0.08);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: "Space Grotesk", "Raleway", system-ui, -apple-system, sans-serif;
      padding: 24px 14px 48px;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1080px;
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
    }

    .header {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .header img {
      height: 54px;
      width: auto;
      object-fit: contain;
    }

    h1 {
      margin: 0;
      letter-spacing: -0.02em;
    }

    .muted {
      color: var(--muted);
      margin: 4px 0 0;
    }

    .note {
      border: 1px dashed #d8deea;
      background: #f8fafc;
      border-radius: 12px;
      padding: 12px;
      margin-top: 8px;
      color: var(--muted);
      line-height: 1.6;
      white-space: pre-line;
    }

    .posts {
      display: grid;
      gap: 12px;
    }

    .lang-switch {
      display: flex;
      gap: 8px;
      margin-left: auto;
      align-items: center;
    }

    .lang-switch button {
      border-radius: 10px;
      border: 1px solid #e4e8f0;
      background: #f7f9fc;
      color: #0f172a;
      font-weight: 700;
      padding: 8px 12px;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }

    .lang-switch button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(20, 27, 47, 0.1);
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .lang-switch button.active {
      background: #0f172a;
      color: #f7f9fc;
      border-color: #0f172a;
    }

    .post {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 16px 40px rgba(20, 27, 47, 0.08);
      overflow: hidden;
    }

    .post-header {
      padding: 12px 14px;
      border-bottom: 1px solid #eef1f6;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e4e8f0;
      background: #f7f9fc;
      color: var(--text);
      font-weight: 700;
      font-size: 0.9rem;
    }

    .pill[data-status="approved"] {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #166534;
    }

    .pill[data-status="changes_requested"] {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #c2410c;
    }

    .pill[data-status="sent_to_client"] {
      background: #eef2ff;
      border-color: #c7d2fe;
      color: #312e81;
    }

    .pill[data-status="draft"] {
      background: #f8fafc;
      border-color: #e2e8f0;
      color: #475569;
    }

    .post-body {
      display: grid;
      gap: 22px;
      padding: 22px 22px 22px;
      grid-template-columns: minmax(260px, 48%) 1fr;
      align-items: flex-start;
    }

    .media {
      border: none;
      background: transparent;
      min-height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .media img,
    .media video {
      border-radius: 0;
      width: 100%;
      height: auto;
      max-height: 620px;
      object-fit: contain;
    }

    .caption {
      margin: 0;
      line-height: 1.6;
      white-space: pre-line;
      font-size: 1.02rem;
      font-family: "Roboto", "Space Grotesk", system-ui, -apple-system, sans-serif;
    }

    .info {
      display: grid;
      gap: 12px;
      width: 100%;
    }

    h3 {
      margin: 0;
      letter-spacing: -0.01em;
    }

    .caption {
      margin: 0;
      line-height: 1.7;
    }

    .cta {
      display: inline-flex;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(254, 190, 1, 0.4);
      background: rgba(254, 190, 1, 0.12);
      font-weight: 700;
      color: #0f172a;
      width: fit-content;
    }

    .feedback {
      border-top: 1px solid #eef1f6;
      padding: 12px 14px 14px;
      display: grid;
      gap: 10px;
      background: #f8fafc;
      width: 100%;
    }

    .feedback .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      width: 100%;
    }

    .feedback textarea {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px;
      font: inherit;
      min-height: 120px;
      resize: vertical;
      background: #fff;
      width: 100%;
    }

    .btn-approve,
    .btn-adjust,
    .btn-send {
      border-radius: 10px;
      border: 1px solid transparent;
      color: #0f172a;
      font-weight: 700;
      padding: 12px 16px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, border-color 0.15s ease;
      width: 100%;
    }

    .btn-send {
      margin-top: 4px;
      align-self: flex-start;
      background: #fcd34d;
      border-color: #f59e0b;
      color: #0f172a;
    }

    .btn-approve[data-active="true"],
    .btn-adjust[data-active="true"] {
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.18);
    }

    .btn-approve:hover:not(:disabled),
    .btn-adjust:hover:not(:disabled),
    .btn-send:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(20, 27, 47, 0.12);
    }

    .sent-box {
      border: 1px dashed #bfdbfe;
      background: #e5edff;
      color: #1e3a8a;
      padding: 14px;
      border-radius: 10px;
      text-align: center;
      font-weight: 700;
    }

    .approve-all {
      margin-top: 18px;
      width: 100%;
      border-radius: 12px;
      border: 1px solid #6ee7b7;
      background: #a7f3d0;
      color: #064e3b;
      font-weight: 800;
      padding: 14px 18px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, border-color 0.15s ease;
    }

    .approve-all:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(20, 27, 47, 0.12);
      background: #6ee7b7;
      border-color: #34d399;
    }

    .btn-approve {
      background: #a7f3d0;
      border-color: #6ee7b7;
      color: #064e3b;
    }

    .btn-adjust {
      background: #c7d2fe;
      border-color: #a5b4fc;
      color: #1e3a8a;
    }

    .btn-approve[data-active="true"] {
      background: #6ee7b7;
      border-color: #34d399;
      box-shadow: 0 0 0 2px rgba(110, 231, 183, 0.35);
    }

    .btn-adjust[data-active="true"] {
      background: #a5b4fc;
      border-color: #818cf8;
      box-shadow: 0 0 0 2px rgba(165, 180, 252, 0.35);
    }

    .empty {
      border: 1px dashed #d7deea;
      border-radius: 14px;
      padding: 14px;
      background: #f8fafc;
      color: var(--muted);
      font-weight: 600;
      text-align: center;
    }

    @media (max-width: 720px) {
      .card {
        padding: 14px;
      }

      .post-body {
        grid-template-columns: 1fr;
      }

      .post-body p.caption {
        margin-top: 0;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="header">
        <img id="clientLogo" src="../img/logo_eleven_black.png" alt="Logo" />
        <div>
          <h1 id="title">Roadmap</h1>
          <p class="muted" id="subtitle"></p>
        </div>
        <div class="lang-switch">
          <button type="button" id="translatePt" data-lang="pt">PT</button>
          <button type="button" id="translateEn" data-lang="en">EN</button>
          <button type="button" id="translateEs" data-lang="es">ES</button>
        </div>
      </div>
      <div class="note" id="notesClient" aria-live="polite"></div>
    </div>

    <section class="posts" id="postsContainer"></section>

    <button class="approve-all" id="approveAllBtn"></button>

    <footer style="margin-top:24px;text-align:center;color:#5a6475;font-weight:700;">
      <span id="footerText">Eleven CM — Roadmap Check Social · Versão 1.0</span>
    </footer>
  </div>

  <div id="loadingOverlay" style="position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;pointer-events:none;z-index:999;">
    <div style="margin-top:18px;width:90%;max-width:320px;height:6px;background:#e2e8f0;border-radius:999px;overflow:hidden;box-shadow:0 10px 30px rgba(15,23,42,0.12);">
      <div id="loadingBar" style="height:100%;width:0%;background:#fcd34d;transition:width 0.3s ease;"></div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzix5fHMp_bu9qRILNypw_Zl3d6wwYQ2N_ihUVG3sm-JfHXOeN0cA1_dMHMTaxkOGHQ1g/exec"; // endpoint único
    let loadingCount = 0;
    const translations = {};
    let currentLang = "pt";

    const UI_STRINGS = {
      pt: {
        approve: "Aprovar",
        adjust: "Pedir ajustes",
        send: "Enviar feedback",
        approveAll: "Aprovar todos",
        feedbackSent: "Feedback enviado.",
        commentPlaceholder: "Comentário (obrigatório se pedir ajustes)",
        noteDefault: "Revise os posts abaixo e envie seu feedback.",
        empty: "Nenhum post cadastrado para este mês.",
        footer: "Eleven CM — Roadmap Check Social · Versão 1.0",
        invalidLink: "Link inválido. Falta cliente ou mês.",
      },
      en: {
        approve: "Approve",
        adjust: "Request changes",
        send: "Send feedback",
        approveAll: "Approve all",
        feedbackSent: "Feedback sent.",
        commentPlaceholder: "Comment (required if requesting changes)",
        noteDefault: "Review the posts below and send your feedback.",
        empty: "No posts for this month.",
        footer: "Eleven CM — Roadmap Check Social · Version 1.0",
        invalidLink: "Invalid link. Missing client or month.",
      },
      es: {
        approve: "Aprobar",
        adjust: "Pedir ajustes",
        send: "Enviar feedback",
        approveAll: "Aprobar todos",
        feedbackSent: "Feedback enviado.",
        commentPlaceholder: "Comentario (obligatorio si pide ajustes)",
        noteDefault: "Revise los posts abajo y envíe su feedback.",
        empty: "Ningún post para este mes.",
        footer: "Eleven CM — Roadmap Check Social · Versión 1.0",
        invalidLink: "Enlace inválido. Falta cliente o mes.",
      },
    };

    async function request(url, options = {}) {
      showLoading(true);
      const init = { ...options };
      if (init.method === "POST") {
        init.headers = { "Content-Type": "text/plain;charset=utf-8" };
        if (init.body && typeof init.body !== "string") {
          init.body = JSON.stringify(init.body);
        }
      }
      try {
        const resp = await fetch(url, init);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return resp.json();
      } finally {
        showLoading(false);
      }
    }

    async function getRoadmap(client_slug, month) {
      const data = await request(`${API_URL}?action=roadmap&client_slug=${encodeURIComponent(client_slug)}&month=${encodeURIComponent(month)}`);
      return data;
    }

    async function translateTexts(texts, target) {
      try {
        const resp = await fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" + target + "&dt=t&q=" + encodeURIComponent(texts.join("\n|||SEP|||\n")));
        const json = await resp.json();
        const flat = json?.[0]?.map((item) => item?.[0] || "") || [];
        const joined = flat.join("");
        return joined.split("|||SEP|||");
      } catch (_) {
        return texts;
      }
    }

    async function updateFeedback(roadmapId, postId, { status, client_comment }) {
      if (status === "changes_requested" && !client_comment.trim()) {
        throw new Error("Comentário obrigatório ao pedir ajustes.");
      }
      const resp = await request(API_URL, {
        method: "POST",
        body: {
          action: "roadmap_feedback",
          roadmap_id: roadmapId,
          post_id: postId,
          status,
          client_comment,
        },
      });
      return resp;
    }

    function parseRoute() {
      const { pathname, search } = window.location;
      const params = new URLSearchParams(search);
      const qsClient = params.get("client_slug");
      const qsMonth = params.get("month");
      const parts = pathname.split("/").filter(Boolean);
      const roadIdx = parts.lastIndexOf("roadmap");
      const slugFromPath = parts[roadIdx + 1];
      const monthFromPath = parts[roadIdx + 2];
      return {
        client_slug: qsClient || slugFromPath || "",
        month: qsMonth || monthFromPath || "",
      };
    }

    function drivePreview(url) {
      if (!url) return "";
      const str = String(url);
      if (str.startsWith("blob:")) return str;
      let id = "";
      // formatos comuns: /file/d/ID/view..., uc?id=ID, open?id=ID
      const m1 = str.match(/\/file\/d\/([^/]+)/);
      const m2 = str.match(/[?&]id=([^&]+)/);
      if (m1 && m1[1]) id = m1[1];
      else if (m2 && m2[1]) id = m2[1];
      if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1600`;
      return str;
    }

    function formatDate(raw) {
      if (!raw) return "";
      const date = new Date(raw);
      if (Number.isNaN(date.getTime())) return raw;
      return date.toLocaleDateString("pt-BR", { day: "2-digit", month: "long" });
    }

    function normalizeMonth(value) {
      if (value instanceof Date) {
        const y = value.getFullYear();
        const m = String(value.getMonth() + 1).padStart(2, "0");
        return `${y}-${m}`;
      }
      const s = String(value || "").trim();
      const match = s.match(/^(\d{4})[-/](\d{2})/);
      if (match) return `${match[1]}-${match[2]}`;
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0, 7);
      return s;
    }

    function render(payload) {
      const data = payload || {};
      const client = data.client || {};
      const roadmap = data.roadmap || {};
      const posts = Array.isArray(data.posts) ? data.posts : [];
      console.log("Render roadmap_public", { client, roadmap, postsCount: posts.length, posts });

      const strings = UI_STRINGS[currentLang] || UI_STRINGS["pt"];

      const titleEl = document.getElementById("title");
      const subtitleEl = document.getElementById("subtitle");
      const notesEl = document.getElementById("notesClient");
      const logoEl = document.getElementById("clientLogo");
      const container = document.getElementById("postsContainer");

      const monthLabel = normalizeMonth(roadmap.month || "");
      const pageTitle = roadmap.title || (monthLabel ? `Roadmap Social – ${monthLabel}` : "Roadmap");
      titleEl.textContent = pageTitle;
      document.title = pageTitle;
      subtitleEl.textContent = [client.name, monthLabel].filter(Boolean).join(" · ");
      notesEl.textContent = roadmap.notes_client || client.default_notes_client || strings.noteDefault;
      if (client.logo_url) logoEl.src = client.logo_url;

      if (!posts.length) {
        container.innerHTML = `<div class="empty">${strings.empty}</div>`;
        return;
      }

      container.innerHTML = posts
        .sort((a, b) => (a.date || "").localeCompare(b.date || "") || (a.order || 0) - (b.order || 0))
        .map((post) => {
          const media = drivePreview(post.drive_asset_url);
          console.log("Post media", post.id, media);
          const hasImg = media && /\.(png|jpe?g|webp|gif)$/i.test(media);
          const isVideo = media && /\.(mp4|mov|webm)$/i.test(media);
          const alreadySent = post.status === "approved" || post.status === "changes_requested";
          return `
            <article class="post" data-id="${post.id}" data-roadmap="${post.roadmap_id}" data-status="${post.status}">
              <div class="post-header">
                ${post.date ? `<span class="pill">${formatDate(post.date)}</span>` : ""}
                ${post.channel ? `<span class="pill">${post.channel}</span>` : ""}
              </div>
              <div class="post-body">
                ${
                  media
                    ? `<div class="media">${
                        hasImg
                          ? `<img src="${media}" data-src="${media}" alt="${post.caption || "Post"}" loading="lazy" referrerpolicy="no-referrer" onerror="this.dataset.error=true;">`
                          : isVideo
                          ? `<video controls src="${media}"></video>`
                          : `<img src="${media}" data-src="${media}" alt="${post.caption || "Post"}" loading="lazy" referrerpolicy="no-referrer" onerror="this.dataset.error=true;">`
                      }</div>`
                    : ""
                }
                <div class="info">
                  ${post.caption ? `<p class="caption">${post.caption}</p>` : ""}
                  <div class="feedback" data-feedback="${post.id}">
                    ${
                      alreadySent
                        ? `<div class="sent-box">Feedback enviado.</div>`
                        : `
                          <div class="btn-row">
                            <button class="btn-approve" data-action="chooseStatus" data-value="approved" data-id="${post.id}" ${post.status === "approved" ? "data-active=\"true\"" : ""}>${strings.approve}</button>
                            <button class="btn-adjust" data-action="chooseStatus" data-value="changes_requested" data-id="${post.id}" ${post.status === "changes_requested" ? "data-active=\"true\"" : ""}>${strings.adjust}</button>
                          </div>
                          <div class="comment-box" data-comment-box="${post.id}" style="${post.status === "changes_requested" ? "" : "display:none;"}">
                            <textarea placeholder="${strings.commentPlaceholder}" data-textarea="${post.id}">${post.client_comment || ""}</textarea>
                          </div>
                          <button data-action="sendFeedback" data-id="${post.id}" class="btn-send" style="${post.status === "changes_requested" ? "" : "display:none;"}">${strings.send}</button>
                        `
                    }
                  </div>
                </div>
              </div>
            </article>
          `;
        })
        .join("");

      // fallback se imagem não carregar
      container.querySelectorAll(".media img").forEach((img) => {
        img.addEventListener("error", () => {
          const src = img.dataset.src || img.src || "";
          const box = img.parentElement;
          if (box) {
            box.innerHTML = `<a href="${src}" target="_blank" rel="noreferrer">Abrir arte no Drive</a>`;
          }
        });
        // se carregou, limpa flag de erro
        img.addEventListener("load", () => {
          if (img.dataset.error) delete img.dataset.error;
        });
      });
    }

    document.getElementById("postsContainer").addEventListener("click", async (event) => {
      if (event.target.dataset.action === "sendFeedback") {
        const postId = event.target.dataset.id;
        const card = event.target.closest("[data-roadmap]");
        const roadmapId = card?.dataset.roadmap;
        const status = card.querySelector(`[data-active="true"][data-id="${postId}"]`)?.dataset.value || "sent_to_client";
        const comment = card.querySelector(`[data-textarea="${postId}"]`)?.value || "";
        try {
          await updateFeedback(roadmapId, postId, { status, client_comment: comment });
          const { client_slug, month } = parseRoute();
          const data = await getRoadmap(client_slug, month);
          render(data);
          window.scrollTo({ top: card.offsetTop - 12, behavior: "smooth" });
        } catch (err) {
          alert(err.message || "Erro ao enviar feedback.");
        }
      } else if (event.target.dataset.action === "chooseStatus") {
        const btn = event.target;
        const postId = btn.dataset.id;
        const card = btn.closest("[data-roadmap]");
        const allBtns = card.querySelectorAll(`[data-action="chooseStatus"][data-id="${postId}"]`);
        const alreadyActive = btn.getAttribute("data-active") === "true";
        allBtns.forEach((b) => b.removeAttribute("data-active"));
        if (!alreadyActive) {
          btn.setAttribute("data-active", "true");
        }
        const commentBox = card.querySelector(`[data-comment-box="${postId}"]`);
        const sendBtn = card.querySelector(`[data-action="sendFeedback"][data-id="${postId}"]`);
        if (btn.dataset.value === "changes_requested") {
          const show = !alreadyActive;
          if (commentBox) commentBox.style.display = show ? "" : "none";
          if (sendBtn) {
            sendBtn.style.display = show ? "" : "none";
          }
        } else {
          if (commentBox) commentBox.style.display = "none";
          if (sendBtn) sendBtn.style.display = "none";
          // Aprovar envia direto
          const roadmapId = card?.dataset.roadmap;
          try {
            await updateFeedback(roadmapId, postId, { status: "approved", client_comment: "" });
            const { client_slug, month } = parseRoute();
            const data = await getRoadmap(client_slug, month);
            render(data);
          } catch (err) {
            alert(err.message || "Erro ao enviar aprovação.");
          }
        }
      }
    });

    document.getElementById("postsContainer").addEventListener("input", (event) => {
      const textarea = event.target.closest("textarea");
      if (!textarea) return;
      const postId = textarea.dataset.textarea;
      if (!postId) return;
      const card = textarea.closest("[data-roadmap]");
      const sendBtn = card?.querySelector(`[data-action="sendFeedback"][data-id="${postId}"]`);
      const isAdjust = card?.querySelector(`[data-active="true"][data-id="${postId}"]`)?.dataset.value === "changes_requested";
      if (sendBtn) {
        sendBtn.style.display = isAdjust ? "" : "none";
      }
    });

    document.getElementById("approveAllBtn").addEventListener("click", async () => {
      try {
        const cards = Array.from(document.querySelectorAll("[data-roadmap]"));
        const adjustments = cards.filter((c) => c.dataset.status === "changes_requested");
        const approvables = cards.filter((c) => c.dataset.status !== "changes_requested" && c.dataset.status !== "approved");
        if (!approvables.length) {
          alert("Nenhum post pendente para aprovar.");
          return;
        }
        if (adjustments.length) {
          alert("Existe(m) post(s) com ajustes solicitados. Apenas os demais serão aprovados.");
        }
        for (const card of approvables) {
          const postId = card.dataset.id;
          const roadmapId = card.dataset.roadmap;
          await updateFeedback(roadmapId, postId, { status: "approved", client_comment: "" });
        }
        const { client_slug, month } = parseRoute();
        const data = await getRoadmap(client_slug, month);
        render(data);
        window.scrollTo({ top: 0, behavior: "smooth" });
        alert("Todos os posts foram aprovados.");
      } catch (err) {
        alert(err.message || "Erro ao aprovar todos.");
      }
    });

    async function applyTranslation(lang) {
      try {
        currentLang = lang;
        updateLangButtons();
        if (translations[lang]) {
          render(translations[lang]);
          return;
        }
        const base = translations["pt"];
        if (!base) return;
        const captions = (base.posts || []).map((p) => p.caption || "");
        const notes = base.roadmap?.notes_client || "";
        const texts = captions.concat(notes);
        const translated = await translateTexts(texts, lang);
        const translatedCaptions = translated.slice(0, captions.length);
        const translatedNotes = translated[translated.length - 1];
        const clone = JSON.parse(JSON.stringify(base));
        clone.roadmap.notes_client = translatedNotes;
        clone.posts = (clone.posts || []).map((p, idx) => ({ ...p, caption: translatedCaptions[idx] || p.caption }));
        translations[lang] = clone;
        render(clone);
      } catch (err) {
        alert("Falha ao traduzir. Tente novamente.");
      }
    }

    function updateLangButtons() {
      const btns = document.querySelectorAll(".lang-switch button");
      btns.forEach((b) => {
        if (b.dataset.lang === currentLang) {
          b.classList.add("active");
        } else {
          b.classList.remove("active");
        }
      });
      const strings = UI_STRINGS[currentLang] || UI_STRINGS["pt"];
      const approveAllBtn = document.getElementById("approveAllBtn");
      const footerText = document.getElementById("footerText");
      if (approveAllBtn) approveAllBtn.textContent = strings.approveAll;
      if (footerText) footerText.textContent = strings.footer;
      const notesEl = document.getElementById("notesClient");
      if (notesEl && !notesEl.textContent.trim()) notesEl.textContent = strings.noteDefault;
    }

    document.getElementById("translatePt").addEventListener("click", () => {
      currentLang = "pt";
      updateLangButtons();
      if (translations["pt"]) render(translations["pt"]);
    });
    document.getElementById("translateEn").addEventListener("click", () => applyTranslation("en"));
    document.getElementById("translateEs").addEventListener("click", () => applyTranslation("es"));

    function showLoading(show) {
      const overlay = document.getElementById("loadingOverlay");
      const bar = document.getElementById("loadingBar");
      if (!overlay || !bar) return;
      if (show) {
        loadingCount += 1;
        overlay.style.display = "flex";
        bar.style.width = "30%";
        setTimeout(() => (bar.style.width = "70%"), 200);
      } else {
        loadingCount = Math.max(loadingCount - 1, 0);
        if (loadingCount === 0) {
          bar.style.width = "100%";
          setTimeout(() => {
            overlay.style.display = "none";
            bar.style.width = "0%";
          }, 250);
        }
      }
    }

    async function init() {
      try {
        const { client_slug, month } = parseRoute();
        if (!client_slug || !month) throw new Error((UI_STRINGS[currentLang] || UI_STRINGS["pt"]).invalidLink);
        const data = await getRoadmap(client_slug, month);
        // Tenta reordenar mês normalizado se vier como ISO
        data.roadmap.month = normalizeMonth(data.roadmap.month);
        // Evita cache incômodo de browser com dados antigos
        render(data);
        translations["pt"] = data;
        updateLangButtons();
      } catch (err) {
        console.error("Erro ao carregar roadmap público:", err);
        document.getElementById("postsContainer").innerHTML = `<div class="empty">${err.message}</div>`;
      }
    }

    init();
  </script>
</body>

</html>
